#!/bin/bash

# ========== Color Setup ==========
green="\e[38;5;87m"
red="\e[38;5;196m"
neutral="\e[0m"
yellow="\e[38;5;226m"
reset="\e[0m"

# ========== Remove Previous Bot ==========
hapus_bot_lama() {
  echo -e "${yellow}Menghapus bot lama...${neutral}"
  systemctl stop sellvpn.service 2>/dev/null
  systemctl disable sellvpn.service 2>/dev/null
  rm -f /etc/systemd/system/sellvpn.service
  rm -rf /root/BotVPN2

  if command -v pm2 &> /dev/null; then
    pm2 delete sellvpn &> /dev/null
    pm2 save &> /dev/null
  fi

  systemctl daemon-reload
  echo -e "${green}Bot lama berhasil dihapus.${neutral}"
}

# ========== Install Dependencies ==========
pasang_package() {
  echo -e "${yellow}Install dependensi...${reset}"
  apt update -y
  apt install -y nodejs npm git curl dos2unix jq ufw \
    build-essential libcairo2-dev libpango1.0-dev libjpeg-dev \
    libgif-dev librsvg2-dev pkg-config libpixman-1-dev

  npm install -g pm2
}

# ========== Setup Bot ==========
setup_bot() {
  timedatectl set-timezone Asia/Jakarta

  echo -e "${yellow}Clone repo bot...${reset}"
  git clone https://github.com/mudziboy/mdzitr.git /root/BotVPN2

  # pindah ke folder BhotVpn-main lalu ambil semua file ke /root/BotVPN2
  cp -r /root/BotVPN2/BhotVpn-main/* /root/BotVPN2/
  rm -rf /root/BotVPN2/BhotVpn-main

  echo -e "${yellow}Install NPM packages...${reset}"
  cd /root/BotVPN2
  npm install sqlite3 express crypto telegraf axios dotenv node-cron winston

  chmod +x /root/BotVPN2/*
}

# ========== Firewall ==========
set_firewall() {
  echo -e "${yellow}Mengaktifkan firewall...${reset}"
  ufw allow 22
  ufw allow 80
  ufw allow 443
  ufw allow 50123
  ufw --force enable
}

# ========== Konfigurasi Bot ==========
server_app() {
  clear
  echo -e "${yellow}::: KONFIGURASI BOT VPN TELEGRAM :::${neutral}"

  read -p "Masukkan Token Bot      : " token
  read -p "Masukkan Admin ID       : " adminid
  read -p "Masukkan ID Grup Telegram : " groupid
  read -p "Masukkan Nama Store     : " namastore
  read -p "Masukkan DATA QRIS      : " dataqris
  read -p "Masukkan MERCHANT ID    : " merchantid
  read -p "Masukkan API KEY        : " apikey

  cat <<EOF > /root/BotVPN2/.vars.json
{
  "BOT_TOKEN": "$token",
  "USER_ID": "$adminid",
  "GROUP_ID": "$groupid",
  "NAMA_STORE": "$namastore",
  "PORT": "50123",
  "DATA_QRIS": "$dataqris",
  "MERCHANT_ID": "$merchantid",
  "API_KEY": "$apikey"
}
EOF

  echo -e "${yellow}Menjalankan bot dengan PM2...${neutral}"
  cd /root/BotVPN2
  pm2 start app.js --name sellvpn --log /var/log/sellvpn.log
  pm2 save
  pm2 startup

  echo -e "${green}Bot VPN telah aktif. Cek Telegram!${neutral}"
}

# ========== EXECUTOR ==========
if [[ ${1} == "sellvpn" ]]; then
  hapus_bot_lama
  pasang_package
  setup_bot
  set_firewall
  server_app
else
  echo -e "${red}Gunakan perintah: ${yellow}bash start2 sellvpn${neutral}"
  exit 1
fi
